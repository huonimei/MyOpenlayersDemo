<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>绘制图形并量出每一边的长度基础demo</title>
    <meta http-equiv=Content-Type content="text/html;charset=utf-8">
    <meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1">
    <meta content=always name=referrer>
    <link rel="stylesheet" href="https://openlayers.org/en/v4.6.2/css/ol.css" type="text/css">
    <!-- The line below is only needed for old environments like Internet Explorer and Android 4.x -->
    <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script>
    <script src="https://openlayers.org/en/v4.6.2/build/ol.js"></script>
    <script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
</head>
<body>
<div id="map">
</div>
<div id="scalebar"></div>
<script type="text/javascript">
    var firstxdot;
    var firstydot;
    var format = 'image/png';
    var bounds = [0.0005950317751121, 0.0008108268570922, 0.0067774664494178, 0.003885651474484];
    var untiled = new ol.layer.Image({
        source: new ol.source.ImageWMS({
            ratio: 1,
            url: 'http://192.168.0.69:7000/geoserver/sicp_base_map/wms',
            params: {
                'FORMAT': format,
                'VERSION': '1.1.1',
                LAYERS: 'sicp_base_map:map_funing',
                STYLES: 'greylines'
            }
        })
    });
    var projection = new ol.proj.Projection({
        code: 'EPSG:4326',
        units: 'degrees',
        axisOrientation: 'neu'
    });


    var source = new ol.source.Vector();
    //定义矢量图层
    var vector = new ol.layer.Vector({
        source: source
    });
    var map = new ol.Map({
        target: 'map',
        layers: [untiled, vector],
        view: new ol.View({
            projection: projection,
            zoom: 18,
            minZoom: 18
        })
    });
    map.getView().fit(bounds, map.getSize());
    //添加比例尺控件
    var scaleLineControl = new ol.control.ScaleLine({
        units: 'metric',
        target: 'scalebar',
        className: 'ol-scale-line'
    });
    map.addControl(scaleLineControl);

    draw_fence('Polygon');
    function draw_fence(fencetype) {
        var wgs84Sphere = new ol.Sphere(6378137);
        var sketch = new ol.Feature();
        var helpTooltipElement;
        var helpTooltip;
        var measureTooltipElement;
        var measureTooltip;
        var clickcount = 0;
        var callnumber = 0;
        var type = 'Point';
        var clickMoveHandler = function (evt) {
            clickcount = 1;
            callnumber++;
            if (callnumber == 1) {
                measureTooltipElement.innerHTML = '参考x点';
                measureTooltip.setPosition(evt.coordinate);
                createMeasureTooltip();
            }
            if (callnumber == 2) {
                measureTooltipElement.innerHTML = '参考y点';
                measureTooltip.setPosition(evt.coordinate);
                map.removeInteraction(draw);
                type = fencetype;
                addInteraction(fencetype);
                createMeasureTooltip();
            }

        };
        map.on('singleclick', clickMoveHandler);
        /***
         * 鼠标移动事件的handler
         * @param evt
         */
        var pointerMoveHandler = function (evt) {
            if (evt.dragging) {
                return;
            }
            if (type == 'Point') {
                if (clickcount == 0) {
                    helpMsg = '点击确定第一个参考x点';
                }
                if (clickcount == 1) {
                    helpMsg = '点击确定第一个参考y点';
                }
            } else {
                var output = formatlen(evt);
                helpMsg = output;
            }
            if (sketch) {
                var geom = sketch.getGeometry();
                if (geom instanceof ol.geom.Polygon) {
                    helpMsg = formatLength(sketch.getGeometry());
                }
                helpTooltipElement.innerHTML = helpMsg;
                helpTooltip.setPosition(evt.coordinate);
                $(helpTooltipElement).addClass('hidden');
            }
        };
        //注册鼠标移动事件
        map.on('pointermove', pointerMoveHandler);

        $(map.getViewport()).on('mouseout', function () {
            $(helpTooltipElement).addClass('hidden');
        });
        var draw;

        /***
         * 添加交互
         */
        function addInteraction(type) {
            var geometryFunction = type == 'Circle' ? ol.interaction.Draw.createBox() : '';
            draw = new ol.interaction.Draw({
                source: source,
                type: type,
                geometryFunction: geometryFunction
            });
            map.addInteraction(draw);
            createMeasureTooltip();
            createHelpTooltip();
            if (type == 'Polygon') {
                var listener;
                var count = 0;
                draw.on('drawstart', function (evt) {
                    sketch = evt.feature;
                    var tooltipsCoord = evt.coordinate;
                    listener = sketch.getGeometry().on('change', function (evt) {
                        var geom = evt.target;
                        var output;
                        if (geom instanceof ol.geom.Polygon) {
                            output = formatLength(geom);
                        }
                        measureTooltipElement.innerHTML = output;
                        measureTooltip.setPosition(tooltipsCoord);
                    });
                    //地图单击事件
                    map.on('singleclick', function (evt) {
                        measureTooltip.setPosition(evt.coordinate);
                        if (count == 0) {
                            measureTooltipElement.innerHTML = "起点";
                        }
                        var point = new ol.geom.Point(evt.coordinate);
                        source.addFeature(new ol.Feature(point));
                        measureTooltipElement.className = 'tooltips tooltips-static';
                        createMeasureTooltip();
                        count++;
                    });

                }, this);
                draw.on('drawend', function (evt) {
                    count = 0;
                    sketch = null;
                    createMeasureTooltip();
                    ol.Observable.unByKey(listener);
                    map.removeEventListener('singleclick');
                }, this);
            }
            if (type == 'Point') {
                draw.on('drawend', function (evt) {
                    console.log('callcount:', callnumber, 'coornde', evt.feature.getGeometry().getCoordinates());
                    if (callnumber == 0) {
                        firstxdot = evt.feature.getGeometry().getCoordinates();
                    }
                    if (callnumber == 1) {
                        firstydot = evt.feature.getGeometry().getCoordinates();
                    }
                }, this);
            }
        }

        /***
         *创建帮助提示框
         */
        function createHelpTooltip() {
            if (helpTooltipElement) {
                helpTooltipElement.parentNode.removeChild(helpTooltipElement);
            }
            helpTooltipElement = document.createElement('div');
            helpTooltipElement.className = 'tooltips hidden';
            helpTooltip = new ol.Overlay({
                element: helpTooltipElement,
                offset: [15, 0],
                positioning: 'center-left'
            });
            map.addOverlay(helpTooltip);
        }

        /***
         * 创建测量提示框
         */
        function createMeasureTooltip() {
            measureTooltipElement = document.createElement('div');
            measureTooltipElement.setAttribute('id', 'lengthLabel');
            measureTooltipElement.className = 'tooltips tooltips-measure';
            measureTooltip = new ol.Overlay({
                element: measureTooltipElement,
                offset: [0, -15],
                positioning: 'bottom-center'
            });
            map.addOverlay(measureTooltip);
        }

        /***
         * 计算不规则图形各个线段的长度
         * @param line
         * @returns {*}
         */
        var formatLength = function (line) {
            var length;
            var coordinates = line.getLinearRing(0).getCoordinates();
            length = 0;
            var c1 = coordinates[coordinates.length - 1];
            var c2 = coordinates[coordinates.length - 2];
            length = wgs84Sphere.haversineDistance(c1, c2);
            var output;
            if (length > 1000) {
                output = (Math.round(length / 1000 * 100) / 100) + ' ' + 'km'; //换算成KM单位
            } else {
                output = (Math.round(length * 100) / 100) + ' ' + 'm'; //m为单位
            }
            return output;
        };
        //计算规则长方形的宽高
        var formatArea = function (polygon) {
            var area;
            var sourceProj = map.getView().getProjection();
            var geom = polygon.clone().transform(sourceProj, 'EPSG:4326');
            var coordinates = geom.getLinearRing(0).getCoordinates();
            area = Math.abs(wgs84Sphere.geodesicArea(coordinates));
            var output;
            var length = 0;
            length = wgs84Sphere.haversineDistance(coordinates[coordinates.length - 1], coordinates[coordinates.length - 2]);
            var heights = 0;
            heights = wgs84Sphere.haversineDistance(coordinates[1], coordinates[2]);
            output = '宽:' + (Math.round(length * 100) / 100) + ' ' + 'm' + '高:' + (Math.round(heights * 100) / 100) + ' ' + 'm';
            return output;
        };
        //计算偏移量
        var formatlen = function (evt) {
            var output;
            var length = 0;
            length = wgs84Sphere.haversineDistance(evt.coordinate, firstxdot);
            var heights = 0;
            heights = wgs84Sphere.haversineDistance(evt.coordinate, firstydot);
            output = '单击确认起点</br>' + '距离参考x点:' + (Math.round(length * 100) / 100) + ' ' + 'm' + '</br>距离参考y点:' + (Math.round(heights * 100) / 100) + ' ' + 'm';
            return output;
        };
        //添加交互绘图对象
        addInteraction('Point');

    }
</script>
</body>
</html>
